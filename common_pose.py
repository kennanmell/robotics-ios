#! /usr/bin/env python

from threading import Thread
from fetch_api import Arm, Torso, Base
import rospy
import tf
import math
from geometry_msgs.msg import Pose, PoseStamped

def wait_for_time():
    while rospy.Time().now().to_sec() == 0:
        pass
def rotate_base(rads):
    b = Base()
    b.turn(rads)

def get_current_gripper_pose():
    # rospy.init_node("gripper_pose_reader")
    listener = tf.TransformListener()
    rospy.sleep(0.1)
    transform = listener.lookupTransform('base_link', 'wrist_roll_link', rospy.Time(0))
    return transform

def get_pose(position, orientation):
    pose = Pose()
    pose.position.x = position[0]
    pose.position.y = position[1]
    pose.position.z = position[2]
    pose.orientation.x = orientation[0]
    pose.orientation.y = orientation[1]
    pose.orientation.z = orientation[2]
    pose.orientation.w = orientation[3]
    return pose

def get_pose_stamped(pose, frame_id='base_link'):
    ps = PoseStamped(pose=pose)
    ps.header.frame_id = frame_id
    ps.header.stamp = rospy.Time.now()
    return ps

GRIPPER_INIT_POSE = ([0.05629574200314329, -0.1758155809789218, 1.0147567021849901], [-0.7100140419364234, 0.041508636572643066, -0.7025522183479911, -0.02403068532729804])

GRIPPER_START_NAV_POSE = ([-0.28090997697643605, 0.2462498538252318, 1.1029694087072481], [-0.7065367445526678, 0.04637212466308408, -0.7057492305604214, -0.023947405173068113])

# pose keyframes, starting from hand out to user, ending with hand behind back
# v1
gripper_init_poses = [
([0.4323276385883991, -0.11961497935653465, 1.0271452665763374], [-0.7075491895059671, 0.05008941970860987, -0.7045314170085022, -0.02237581083884429]),
([0.3067540324023486, -0.31821258732299806, 1.0214949009482273], [-0.707295332464289, 0.04295415980226903, -0.7052103503168408, -0.023803668538913837]),
([0.10888522846776973, -0.38890615546582863, 1.020399107196734], [-0.709568052781743, 0.04112115198322152, -0.7029874384927204, -0.025117536753083473]),
([-0.08280936110650311, -0.4130052726375922, 1.0208329933994178], [-0.7093385603727553, 0.04515719682395273, -0.7028202758214637, -0.02903952887964497]),
([-0.2751450769846198, -0.28698821488130166, 1.0262726380722058], [-0.7118234145268381, 0.0460891386569117, -0.700532461644826, -0.020916214070846394])
]
# v2
#gripper_init_poses = [([0.4733186252739105, 0.05757831714772086, 1.2669606840860341], [0.06781097321141841, -0.7003772350145347, 0.07409637508711264, 0.7066704520386186]),
#([0.4110664430566746, 0.20846479999867476, 1.2651312602312728], [-0.20483858623056275, 0.6666998089755775, -0.21100044832249723, -0.6848586197973253]),
##([0.3590626227823226, 0.2781772459422134, 1.264473829101413], [-0.28969625877020433, 0.6352077750716542, -0.3010303511526612, -0.6495905539861022]),
##([0.3032706018171788, 0.3254886441573741, 1.2642101959138827], [-0.3477656666625014, 0.6059797132887331, -0.3549331783110178, -0.621184406683981]),
#([0.218629359572088, 0.3744946513482377, 1.2642495563049012], [-0.42309407748602357, 0.5552651457204605, -0.434921279042435, -0.5687842302493787]),
#([0.12804970567822205, 0.3998904564964354, 1.2647497315507108], [-0.41806611837566515, 0.5594411525142824, -0.43032687295761035, -0.571896056945946]),
#([0.04024013648292006, 0.40728314218755146, 1.2654391871412385], [-0.4763150207307607, 0.5124321485183939, -0.4780492723990336, -0.5310425475890161]),
#([-0.06535635471472395, 0.4161852858648549, 1.2664445618848037], [-0.5189784206432858, 0.4723241044002749, -0.5201238737763259, -0.48687010098894745]),
#([-0.15347429545586067, 0.40951454501074336, 1.2675291977049161], [0.5773298650393236, -0.39760271098367306, 0.5810751343250482, 0.41346583827595407]),
#([-0.23281703544481375, 0.37989720044456077, 1.2687240960924873], [0.6175703157085308, -0.3540277262837958, 0.6048354508200009, 0.3569948901726153]),
##([-0.23273266986355606, 0.37985265014041464, 1.268698338482926], [0.6835602692576944, -0.20358176899671537, 0.6732126719476275, 0.19515255559088146]),
##([-0.229781265162962, 0.2896632596441191, 1.2676717486854627], [-0.7156339174949822, 0.012178199381208545, -0.6983330587489736, -0.0071222643112366585]),
#([-0.23261100922800498, 0.28073196396582123, 1.2676146955584113], [-0.7117034662131618, 0.009461183763263138, -0.7023687710752998, -0.008171389119458939])]
# v3
rotation_direction = 1
gripper_init_poses = [
([0.6288176038534237, -0.0057337487629906736, 1.1832319186895508], [7.881917592698119e-05, -0.7032449056380348, 0.02178513449220857, 0.710613822266951]),
([0.42068084208600637, -0.33140551310650823, 1.1954831185193433], [-0.2618985504664685, -0.6551605682139597, -0.23710394514528468, 0.6677989954452352]),
([0.08558993261980878, -0.41609133112867847, 1.203718779568213], [-0.465722730960484, -0.5458066159496726, -0.4432488489919705, 0.5373340987873082]),
([-0.19495146281717043, -0.3387658844597047, 1.2068335653906157], [-0.6448794434171188, -0.3180660947000415, -0.624896052986156, 0.3040877929523228]),
([-0.1338564764443298, -0.3860906849599869, 1.2069479673258847], [-0.6265494759948715, -0.34730494792243083, -0.6066046126243805, 0.34474029532675127]),
([-0.2528476444221372, -0.2746984489334649, 1.2062355170964911], [-0.7161647231627375, -0.027722048038316204, -0.6973590049044163, 0.005476826501111454]),

#([0.6287714457161384, -0.005801775586911899, 1.1831724186363537], [-0.0006916945502210394, -0.7065548497340912, 0.024519189766588435, 0.7072330416553483]),
#([0.40385108732413133, 0.2381834442045204, 1.186970721673481], [0.12675879345442637, -0.688812109570246, 0.1521756102530398, 0.6973612189070169]),
#([0.22339928197729236, 0.366246967966508, 1.1824460040381142], [0.298647155279975, -0.6305385338246544, 0.3261139606788168, 0.6378720237287477]),
#([-0.03663873453585746, 0.37109028104131614, 1.1823847832111485], [-0.5410148958555273, 0.4302962513024466, -0.5631142608276889, -0.4528248533704621]),
#([-0.21446716672596805, 0.308057626825599, 1.1846455404054224], [0.6806911669475311, -0.17636051538843903, 0.6807248925866172, 0.20535365705161118]),
# ([-0.23975164461727055, 0.25852318632619, 1.1864212622489394], [-0.7061764567448259, -0.014524173986118237, -0.7077243857776385, -0.015167533913203045])
]

def get_init_gripper_pose():
    return get_pose(*GRIPPER_INIT_POSE)

def get_start_nav_gripper_pose():
    return get_pose(*GRIPPER_START_NAV_POSE)

def move_to_poses(arm, pose_list):
    for pose in pose_list:
        arm.move_to_pose(get_pose_stamped(get_pose(*pose)))

def move_to_init_pose():
    rospy.sleep(0.5)
    arm = Arm()
    pose = get_init_gripper_pose()
    b = Base()
    do_in_parallel(lambda: b.turn(-1 * rotation_direction * math.pi), lambda: move_to_poses(arm, gripper_init_poses[::-1]))

def move_to_start_nav_pose():
    rospy.sleep(0.5)
    arm = Arm()
    pose = get_start_nav_gripper_pose()
    b = Base()
    do_in_parallel(lambda: b.turn(rotation_direction * math.pi), lambda: move_to_poses(arm, gripper_init_poses))

def do_in_parallel(*args):
    t_list = list()
    for arg in args:
        t = Thread(target=arg)
        t_list.append(t)
        t.start()
    for t in t_list:
        t.join()


if __name__ == '__main__':
    rospy.init_node("common_pose")
    wait_for_time()
    move_to_start_nav_pose()
    print("moved to start_nav_pose")
    move_to_init_pose()
    print("moved to init_pose")
    rospy.sleep(5)
